---
title: "Analysis of tax services data using R"
subtitle: ""
author: "Zahid Asghar"
institute: ""
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css, extra.css]
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
---

```{r , include=FALSE}
knitr::opts_chunk$set(
  fig.width=9, fig.height=4, fig.retina=2, 
  out.width="100%",
  message = FALSE
)
```


```{r , echo=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#035AA6",
  secondary_color = "#03A696",
  colors = c(yellow = "#FFFC31", pink = "#E56399",orange= "#fb5607",
 blue_violet   = "#8338ec",
 zomp          = "#38A88E",
 shadow        = "#87826E",
 blue          = "#1381B0",
 yellow_orange = "#FF961C")
)
```

```{r qau-logo, echo=FALSE}
xaringanExtra::use_logo(
  image_url = "atomcamp.jpg"
)
```

```{r xaringan-banner, echo=FALSE}
xaringanExtra::use_banner(
  bottom_left = "Quant Methods for SS",
  bottom_right = "Prof.Dr. Zahid Asghar",
  top_left = "",
  exclude = "title-slide"
)
```

---
class: left inverse title-slide
background-image: url(75_yr_pk.png)
background-position:  50% 0%
background-size:  10%
##  Agenda : 5 Important verbs for handling data

--

####   View, glimpse, structure, head, tail

--

####  select() for column selection

--

####  filter() for data filtering

--

####  arrange() Data Ordering

--

####  mutate()  Creating Derived Columns

--

####  summarise()   Calculating Summary Statistics

--

####   group_by()

---

## Required libraries and data upload

```{r data, include = FALSE}
library(tidyverse)
library(lubridate)
library(readr)
library(readxl)
library(collapse)
library(kableExtra)
library(dynlm)
library(forecast)
library(stargazer)
library(scales)
library(xts)
library(urca)
library(tsibble)
library(fpp2)
library(fpp3)
library(ggthemes)
library(DT)
load("D:/RepTemplates/Tax_data/Data.RData") ## Data are loaded
tax<-Data
tax$Date<-lubridate::ym(tax$TAX_PERIOD)
tax$SCODE<-as.character(tax$SCODE)
glimpse(tax)
tax_df<-as.data.frame(tax)
#tax_df<-tax_df %>% mutate(Year = str_replace_all(Year, pattern = ",", replacement = " "))
##tax_df$Date<-as.Date(tax_df$Date)
#tax_df$Date<-as.Date(tax_df$Date)
tax$Month<-tax$TAX_PERIOD-round(tax$TAX_PERIOD,-2)
tax$Month<-month.abb[tax$Month]
tax$GST_RATE<-tax %>% mutate(GST_RATE=SERVICES_TAX/SERVICES_VALUE*100,na.rm=FALSE)

tax_df<-tax %>% select('SCODE', 'SERVICE','Date','TAX_PERIOD','Year', 'Month',
                       'PURCHASE_TAX','PURCHASE_VALUE', 'IMPORT_VALUE','IMPORT_TAX',
                       'SERVICES_VALUE', 'SERVICES_TAX','OUTPUT_TAX', 'GST_RATE')


```

---
# Overall Tax

## Overall Tax Summary
The `tax_summary` dataset provides a summary of the tax collected from around 178 services in Pakistani Rs. This data is for each fiscal year from 2012 to 2018. There are 1,033,223 observations with data on 28 variables.


```{r, echo=FALSE}

tax_df$SCODE<-as.character(tax_df$SCODE)
total_tax<-tax_df %>% group_by(Date) %>% 
  summarise(tax_val=sum(SERVICES_TAX)) %>% mutate(tax_mill=tax_val/1000000)
## Extract year variable from Date
total_tax$year<-year(total_tax$Date)


yearly_tax<-total_tax %>% group_by(year) %>% 
  summarise(tax_by_serv=sum(tax_val))

yearly_tax<-yearly_tax %>% filter(year!=2022)

ggplot(yearly_tax,aes(year, tax_by_serv))+geom_line()+labs(
    title = "Total tax collected from services sector over 2013-2021",
    x = "Fiscal Year",
    y = "Rs in Millions"
  )+theme_economist()
```

---
## Monthly data summary



```{r tax-monthly, echo=FALSE}
ggplot(total_tax, aes(x = Date, y = tax_mill)) +
  geom_line() +
  labs(
    title = "Monthly tax collected from services sector over 2013-2022",
    x = "Fiscal Year",
    y = "Rs in Millions"
  )+theme_economist()
```


---
## Forecasting overall tax_output
There are more than 170 services and if one needs to forecast , it is better to use some statistical forecasting methods in simple possible way. There are several methods but most commonly used methods are 
- Naive Forecasting
- Autoregressive Moving Average Models (ARIMA Models)
- Exponential Smoothing Methods (ETS) and
- Artificial Nueral Network (ANN)

---
## Annual Forecasting

### NAIVE Forecasting

```{r, echo=FALSE}
NAIVE<-forecast::naive(yearly_tax$tax_by_serv, h=1) 
summary(NAIVE)

```


---
### ARIMA models

```{r, echo=FALSE}
fit_arima<-auto.arima(yearly_tax$tax_by_serv, stepwise = FALSE, approximation = FALSE)
summary(fit_arima)
fit_arima %>% forecast(h=1)
```

---

### Aritificial Nueral Networks

```{r, echo=FALSE}
NN <- nnetar(yearly_tax$tax_by_serv, lambda="auto")
fcast2 <- forecast(NN, h=2, PI=TRUE, npaths=100)
autoplot(fcast2, include = 2)
fcast2
accuracy(NN)
```

---

## Monthly forecasting for total tax over time
As annual data are short and one may object that forecasting from such short data is not a good idea, though literature does not warn much on it if there is not huge variability in the data. In this case data quite smooth except one dip which was due to Supreme Court decision to make cellular taxes the same as in other services. As monthly data are available and more granularity always helps to get better insight, therefore, forecasting with three methods : seasonal naive, arima and ANN is given below.  

---

### Seasonal Naive Forecasting

```{r forecasting, echo=FALSE}
fit_SN <- snaive(total_tax$tax_mill)

forecast::snaive((total_tax$tax_mill), h = 24)
fdf<-as.data.frame(forecast::snaive((total_tax$tax_mill), h = 24))
fdf<-forecast(snaive((total_tax$tax_mill), h = 24))
fdf$`Point Forecast`
forecast::snaive((total_tax$tax_mill), h = 24) %>% autoplot()
```

---

```{r, echo=FALSE, eval=FALSE}
#remotes::install_github("jhelvy/renderthis")
library(renderthis)
to_pdf(from = "R4SS.Rmd")

to_gif(from = "R4SS.Rmd")
```



